name: github-release

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ v* æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      tag:
        description: 'å‘å¸ƒæ ‡ç­¾ (ä¾‹å¦‚: v1.0.0)'
        required: true
        type: string

env:
  PROJECT_NAME: cloudpan189-share
  MODULE_NAME: github.com/xxcheng123/cloudpan189-share
  BINARY_NAME: share
  GO_VERSION: '1.24.4'
  NODE_VERSION: '22'

jobs:
  # å…ˆæ„å»ºå‰ç«¯ï¼Œç”Ÿæˆ dist ç›®å½•
  build-frontend:
    name: ğŸ¨ æ„å»ºå‰ç«¯
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ“¦ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            fe/package-lock.json
            fe/package.json

      - name: ğŸ” éªŒè¯å‰ç«¯ç¯å¢ƒ
        run: |
          echo "ğŸ“Š å‰ç«¯ç¯å¢ƒä¿¡æ¯ï¼š"
          echo "Node ç‰ˆæœ¬: $(node --version)"
          echo "NPM ç‰ˆæœ¬: $(npm --version)"
          echo "å·¥ä½œç›®å½•: $(pwd)"
          
          if [ -d "fe" ]; then
            echo "âœ… å‰ç«¯ç›®å½•å­˜åœ¨"
            echo "ğŸ“‹ å‰ç«¯ç›®å½•å†…å®¹ï¼š"
            ls -la fe/
          
            if [ -f "fe/package.json" ]; then
              echo "âœ… æ‰¾åˆ° package.json"
              echo "ğŸ“‹ åŒ…ä¿¡æ¯ï¼š"
              cd fe && npm list --depth=0 2>/dev/null || echo "å°šæœªå®‰è£…ä¾èµ–"
            else
              echo "âŒ æœªæ‰¾åˆ° package.json"
              exit 1
            fi
          else
            echo "âŒ æœªæ‰¾åˆ°å‰ç«¯ç›®å½• 'fe'"
            exit 1
          fi

      - name: ğŸ¨ æ„å»ºå‰ç«¯
        run: |
          echo "ğŸ¨ ä½¿ç”¨ Node.js ${{ env.NODE_VERSION }} æ„å»ºå‰ç«¯..."
          cd fe
          
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm ci --prefer-offline --no-audit
          
          echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
          npm run build
          
          echo "âœ… å‰ç«¯æ„å»ºå®Œæˆ"
          
          # éªŒè¯æ„å»ºäº§ç‰©
          if [ -d "dist" ]; then
            echo "ğŸ“‹ å‰ç«¯æ„å»ºè¾“å‡º (dist/)ï¼š"
            find dist -type f | head -20
            echo "ğŸ“Š dist ç›®å½•æ–‡ä»¶æ€»æ•°: $(find dist -type f | wc -l)"
            echo "ğŸ“Š dist ç›®å½•å¤§å°: $(du -sh dist)"
          else
            echo "âŒ å‰ç«¯æ„å»ºå¤±è´¥ - æœªæ‰¾åˆ° dist ç›®å½•"
            exit 1
          fi

      - name: ğŸ“¤ ä¸Šä¼ å‰ç«¯æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: fe/dist/
          retention-days: 1
          compression-level: 6

  # æ„å»ºå¤šå¹³å°åç«¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä¾èµ–å‰ç«¯æ„å»ºï¼‰
  build-backend:
    name: ğŸ”¨ æ„å»ºåç«¯ (${{ matrix.suffix }})
    runs-on: ubuntu-latest
    needs: build-frontend  # ä¾èµ–å‰ç«¯æ„å»ºå®Œæˆ
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
          - goos: darwin
            goarch: amd64
            suffix: darwin-amd64
          - goos: darwin
            goarch: arm64
            suffix: darwin-arm64
          - goos: windows
            goarch: amd64
            suffix: windows-amd64
            ext: .exe

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯

      - name: ğŸ”§ è®¾ç½® Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
          cache-dependency-path: |
            go.sum
            go.mod

      - name: ğŸ“¥ ä¸‹è½½å‰ç«¯æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: fe/dist/

      - name: ğŸ” éªŒè¯å‰ç«¯èµ„æº
        run: |
          echo "ğŸ” éªŒè¯å‰ç«¯æ„å»ºäº§ç‰©..."
          
          if [ -d "fe/dist" ]; then
            echo "âœ… å‰ç«¯ dist ç›®å½•å·²æ¢å¤"
            echo "ğŸ“‹ å‰ç«¯èµ„æºï¼š"
            find fe/dist -type f | head -20
            echo "ğŸ“Š æ–‡ä»¶æ€»æ•°: $(find fe/dist -type f | wc -l)"
            echo "ğŸ“Š ç›®å½•å¤§å°: $(du -sh fe/dist)"
          else
            echo "âŒ ä¸‹è½½åæœªæ‰¾åˆ°å‰ç«¯ dist ç›®å½•"
            echo "ğŸ“‹ å½“å‰ç›®å½•ç»“æ„ï¼š"
            find . -name "dist" -type d 2>/dev/null || echo "æœªæ‰¾åˆ° dist ç›®å½•"
            exit 1
          fi

      - name: ğŸ” éªŒè¯ Go ç¯å¢ƒ
        run: |
          echo "ğŸ“Š Go ç¯å¢ƒä¿¡æ¯ï¼š"
          echo "Go ç‰ˆæœ¬: $(go version)"
          echo "ç›®æ ‡å¹³å°: ${{ matrix.goos }}/${{ matrix.goarch }}"
          echo "GOPATH: $GOPATH"
          echo "GOROOT: $GOROOT"

      - name: ğŸ“Š ç”Ÿæˆæ„å»ºå˜é‡
        id: vars
        run: |
          echo "VAR_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "VAR_BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          echo "VAR_GIT_SUMMARY=$(git describe --tags --dirty --always)" >> $GITHUB_ENV
          echo "VAR_GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_ENV
          
          # è·å–ç‰ˆæœ¬å·
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.tag }}" >> $GITHUB_ENV
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_ENV
          fi
          
          echo "ğŸ“Š æ„å»ºå˜é‡ï¼š"
          echo "  æäº¤: $(git rev-parse HEAD)"
          echo "  æ—¥æœŸ: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "  æ‘˜è¦: $(git describe --tags --dirty --always)"
          echo "  åˆ†æ”¯: $(git rev-parse --abbrev-ref HEAD)"

      - name: ğŸ”¨ æ„å»º Go äºŒè¿›åˆ¶æ–‡ä»¶ (${{ matrix.suffix }})
        run: |
          echo "ğŸ”¨ ä¸º ${{ matrix.goos }}/${{ matrix.goarch }} æ„å»º Go äºŒè¿›åˆ¶æ–‡ä»¶..."
          
          # åˆ›å»ºè¾“å‡ºç›®å½•
          mkdir -p output
          
          # æ•´ç† Go æ¨¡å—
          echo "ğŸ“¦ æ•´ç† Go æ¨¡å—..."
          go mod tidy
          
          # éªŒè¯ Go æ¨¡å—
          go mod verify
          
          # æ£€æŸ¥ä¸»ç¨‹åºå…¥å£
          if [ ! -f "cmd/main.go" ]; then
            echo "âŒ åœ¨ cmd/main.go æœªæ‰¾åˆ°ä¸»ç¨‹åº"
            echo "ğŸ“‹ å¯ç”¨çš„ Go æ–‡ä»¶ï¼š"
            find . -name "*.go" -type f | head -10
            exit 1
          fi
          
          # æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆåŒ…å«å‰ç«¯èµ„æºï¼‰
          echo "ğŸ”§ æ„å»ºåŒ…å«åµŒå…¥å¼å‰ç«¯èµ„æºçš„äºŒè¿›åˆ¶æ–‡ä»¶..."
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build \
            -ldflags="-s -w \
                      -X ${{ env.MODULE_NAME }}/configs.Commit=${{ env.VAR_COMMIT }} \
                      -X ${{ env.MODULE_NAME }}/configs.BuildDate=${{ env.VAR_BUILD_DATE }} \
                      -X ${{ env.MODULE_NAME }}/configs.GitSummary=${{ env.VAR_GIT_SUMMARY }} \
                      -X ${{ env.MODULE_NAME }}/configs.GitBranch=${{ env.VAR_GIT_BRANCH }}" \
            -trimpath \
            -o output/${{ env.BINARY_NAME }}-${{ matrix.suffix }}${{ matrix.ext }} \
            ./cmd/main.go
          
          # éªŒè¯æ„å»ºç»“æœ
          if [ -f "output/${{ env.BINARY_NAME }}-${{ matrix.suffix }}${{ matrix.ext }}" ]; then
            echo "âœ… äºŒè¿›åˆ¶æ–‡ä»¶æ„å»ºæˆåŠŸ: output/${{ env.BINARY_NAME }}-${{ matrix.suffix }}${{ matrix.ext }}"
          
            # æ˜¾ç¤ºæ–‡ä»¶ä¿¡æ¯
            ls -lh output/${{ env.BINARY_NAME }}-${{ matrix.suffix }}${{ matrix.ext }}
          
            # å¯¹äºé Windows å¹³å°ï¼Œæ˜¾ç¤ºæ–‡ä»¶ç±»å‹
            if [ "${{ matrix.goos }}" != "windows" ]; then
              file output/${{ env.BINARY_NAME }}-${{ matrix.suffix }}${{ matrix.ext }} || true
            fi
          else
            echo "âŒ äºŒè¿›åˆ¶æ–‡ä»¶æ„å»ºå¤±è´¥"
            exit 1
          fi

      - name: ğŸ“¦ åˆ›å»ºå‹ç¼©åŒ…
        run: |
          cd output
          
          if [ "${{ matrix.goos }}" = "windows" ]; then
            echo "ğŸ“¦ ä¸º Windows åˆ›å»º ZIP å‹ç¼©åŒ…..."
            zip -9 ${{ env.BINARY_NAME }}-${{ matrix.suffix }}.zip ${{ env.BINARY_NAME }}-${{ matrix.suffix }}${{ matrix.ext }}
            echo "âœ… å·²åˆ›å»º: ${{ env.BINARY_NAME }}-${{ matrix.suffix }}.zip"
          
            # éªŒè¯ ZIP æ–‡ä»¶
            if command -v unzip >/dev/null 2>&1; then
              echo "ğŸ” éªŒè¯ ZIP å‹ç¼©åŒ…..."
              unzip -t ${{ env.BINARY_NAME }}-${{ matrix.suffix }}.zip
            fi
          else
            echo "ğŸ“¦ ä¸º ${{ matrix.goos }} åˆ›å»º TAR.GZ å‹ç¼©åŒ…..."
            tar -czf ${{ env.BINARY_NAME }}-${{ matrix.suffix }}.tar.gz ${{ env.BINARY_NAME }}-${{ matrix.suffix }}${{ matrix.ext }}
            echo "âœ… å·²åˆ›å»º: ${{ env.BINARY_NAME }}-${{ matrix.suffix }}.tar.gz"
          
            # éªŒè¯ TAR.GZ æ–‡ä»¶
            echo "ğŸ” éªŒè¯ TAR.GZ å‹ç¼©åŒ…..."
            tar -tzf ${{ env.BINARY_NAME }}-${{ matrix.suffix }}.tar.gz
          fi
          
          # æ˜¾ç¤ºæœ€ç»ˆæ–‡ä»¶ä¿¡æ¯
          echo "ğŸ“Š æœ€ç»ˆå‹ç¼©åŒ…ä¿¡æ¯ï¼š"
          ls -lh ${{ env.BINARY_NAME }}-${{ matrix.suffix }}*

      - name: ğŸ“¤ ä¸Šä¼ åç«¯æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: binary-${{ matrix.suffix }}
          path: |
            output/${{ env.BINARY_NAME }}-${{ matrix.suffix }}*
          retention-days: 1
          compression-level: 0  # æ–‡ä»¶å·²ç»å‹ç¼©è¿‡äº†

  # åˆ›å»º GitHub Release
  release:
    name: ğŸ“‹ åˆ›å»º GitHub å‘å¸ƒ
    runs-on: ubuntu-latest
    needs: [build-frontend, build-backend]  # ä¾èµ–å‰ç«¯å’Œåç«¯æ„å»º
    permissions:
      contents: write

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“Š ç”Ÿæˆå‘å¸ƒå˜é‡
        id: vars
        run: |
          # è·å–ç‰ˆæœ¬å·
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          
          # ç”Ÿæˆæ„å»ºä¿¡æ¯
          echo "VAR_COMMIT=$(git rev-parse HEAD)" >> $GITHUB_ENV
          echo "VAR_BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_ENV
          echo "VAR_GIT_SUMMARY=$(git describe --tags --dirty --always)" >> $GITHUB_ENV
          echo "SHORT_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          
          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          echo "ğŸ“ ä¸º $VERSION ç”Ÿæˆå˜æ›´æ—¥å¿—..."
          if git tag --list | grep -q "^${VERSION}$"; then
            # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
            PREV_TAG=$(git tag --sort=-version:refname | grep -v "^${VERSION}$" | head -n1)
            if [ -n "$PREV_TAG" ]; then
              echo "ğŸ“‹ ä¸Šä¸€ä¸ªæ ‡ç­¾: $PREV_TAG"
              echo "CHANGELOG<<EOF" >> $GITHUB_ENV
              echo "## ğŸ‰ $VERSION ç‰ˆæœ¬æ–°ç‰¹æ€§" >> $GITHUB_ENV
              echo "" >> $GITHUB_ENV
              echo "### ğŸ“ è‡ª $PREV_TAG ä»¥æ¥çš„å˜æ›´" >> $GITHUB_ENV
              git log --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" $PREV_TAG..$VERSION | head -20 >> $GITHUB_ENV
              echo "" >> $GITHUB_ENV
              echo "" >> $GITHUB_ENV
              echo "### ğŸ‘¥ è´¡çŒ®è€…" >> $GITHUB_ENV
              git log --pretty=format:"- %an" $PREV_TAG..$VERSION | sort -u | head -10 >> $GITHUB_ENV
              echo "" >> $GITHUB_ENV
              echo "" >> $GITHUB_ENV
              echo "**å®Œæ•´å˜æ›´æ—¥å¿—**: https://github.com/${{ github.repository }}/compare/$PREV_TAG...$VERSION" >> $GITHUB_ENV
              echo "EOF" >> $GITHUB_ENV
            else
              echo "CHANGELOG=## ğŸ‰ å‘å¸ƒ $VERSION" >> $GITHUB_ENV
            fi
          else
            echo "CHANGELOG=## ğŸ‰ å‘å¸ƒ $VERSION" >> $GITHUB_ENV
          fi

      - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ”§ æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          echo "ğŸ”§ æ•´ç†å‘å¸ƒæ–‡ä»¶..."
          
          # åˆ›å»ºå‘å¸ƒç›®å½•
          mkdir -p release-files
          
          # æŸ¥çœ‹ä¸‹è½½çš„æ–‡ä»¶ç»“æ„
          echo "ğŸ“‹ ä¸‹è½½çš„æ–‡ä»¶ç»“æ„ï¼š"
          find artifacts -type f | sort
          
          # ç§»åŠ¨æ‰€æœ‰å‹ç¼©åŒ…åˆ°å‘å¸ƒç›®å½•
          find artifacts -name "*.tar.gz" -o -name "*.zip" | while read file; do
            filename=$(basename "$file")
            echo "ğŸ“¦ ç§»åŠ¨æ–‡ä»¶: $filename"
            cp "$file" "release-files/$filename"
          done
          
          # éªŒè¯å‘å¸ƒæ–‡ä»¶
          echo "ğŸ“Š å‡†å¤‡å‘å¸ƒçš„æ–‡ä»¶ï¼š"
          ls -la release-files/
          
          # ç”Ÿæˆæ ¡éªŒå’Œæ–‡ä»¶
          cd release-files
          echo "ğŸ” ç”Ÿæˆæ ¡éªŒå’Œ..."
          sha256sum *.tar.gz *.zip > SHA256SUMS 2>/dev/null || true
          
          echo "ğŸ“‹ æ ¡éªŒå’Œæ–‡ä»¶å†…å®¹ï¼š"
          cat SHA256SUMS || echo "æœªç”Ÿæˆæ ¡éªŒå’Œæ–‡ä»¶"

      - name: ğŸ“‹ åˆ›å»º GitHub å‘å¸ƒ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.VERSION }}
          name: "ğŸš€ å‘å¸ƒ ${{ env.VERSION }}"
          body: |
            ${{ env.CHANGELOG }}
            
            ## ğŸ“¦ ä¸‹è½½
            
            è¯·æ ¹æ®æ‚¨çš„ç³»ç»Ÿé€‰æ‹©åˆé€‚çš„äºŒè¿›åˆ¶æ–‡ä»¶ã€‚**æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶éƒ½åŒ…å«åµŒå…¥å¼ Web å‰ç«¯ã€‚**
            
            ### ğŸ§ Linux ç³»ç»Ÿ
            - **AMD64 (x86_64)**: [`share-linux-amd64.tar.gz`](https://github.com/${{ github.repository }}/releases/download/${{ env.VERSION }}/share-linux-amd64.tar.gz)
            - **ARM64 (aarch64)**: [`share-linux-arm64.tar.gz`](https://github.com/${{ github.repository }}/releases/download/${{ env.VERSION }}/share-linux-arm64.tar.gz)
            
            ### ğŸ macOS ç³»ç»Ÿ
            - **Intel (x86_64)**: [`share-darwin-amd64.tar.gz`](https://github.com/${{ github.repository }}/releases/download/${{ env.VERSION }}/share-darwin-amd64.tar.gz)
            - **Apple Silicon (ARM64)**: [`share-darwin-arm64.tar.gz`](https://github.com/${{ github.repository }}/releases/download/${{ env.VERSION }}/share-darwin-arm64.tar.gz)
            
            ### ğŸªŸ Windows ç³»ç»Ÿ
            - **AMD64 (x86_64)**: [`share-windows-amd64.zip`](https://github.com/${{ github.repository }}/releases/download/${{ env.VERSION }}/share-windows-amd64.zip)
            
            ## ğŸš€ å¿«é€Ÿå¼€å§‹
            
            ### Linux / macOS ç³»ç»Ÿ
            ```bash
            # ä¸‹è½½ï¼ˆè¯·æ›¿æ¢ä¸ºæ‚¨çš„å¹³å°å¯¹åº”çš„ URLï¼‰
            curl -L -o share.tar.gz https://github.com/${{ github.repository }}/releases/download/${{ env.VERSION }}/share-linux-amd64.tar.gz
            
            # è§£å‹
            tar -xzf share.tar.gz
            
            # æ·»åŠ æ‰§è¡Œæƒé™ï¼ˆå¦‚æœéœ€è¦ï¼‰
            chmod +x share-linux-amd64
            
            # è¿è¡Œï¼ˆWeb ç•Œé¢å°†åœ¨ http://localhost:12395 å¯ç”¨ï¼‰
            ./share-linux-amd64